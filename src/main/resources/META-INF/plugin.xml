<idea-plugin>
    <id>com.cythonfix.cython-fix</id>
    <name>Cython-Fix</name>
    <version>0.3.0</version>
    <vendor email="prog@istvansarandi.com">István Sárándi</vendor>

    <description><![CDATA[
    Fixes PyCharm's built-in Cython parser, formatter, and type resolution bugs.

    <b>Parser fixes:</b>
    <ul>
        <li>False "duplicate parameter name" error on <code>ndim=1</code> in <code>np.ndarray[np.float64_t, ndim=1]</code></li>
        <li>False "duplicate parameter name" error on unnamed parameters in <code>cdef extern</code> declarations like <code>void f(char *, char *)</code></li>
        <li>False "duplicate parameter name" and "non-default parameter follows default parameter" errors on type bracket arguments like <code>map[void_ptr, void*]</code></li>
        <li><code>sizeof()</code> with complex expressions like <code>sizeof(self.ptr[0].field)</code> no longer fails to parse</li>
    </ul>

    <b>Formatter fixes:</b>
    <ul>
        <li>Pointer declarations mangled: <code>float **x</code> → <code>float ** x</code></li>
    </ul>

    <b>Type resolution fixes:</b>
    <ul>
        <li>"Unexpected parameter" on <code>cdef class</code> constructors using <code>__cinit__</code> instead of <code>__init__</code></li>
    </ul>

    <b>Highlighting fixes:</b>
    <ul>
        <li>Docstrings in <code>cdef</code>/<code>cpdef</code> functions shown as plain strings instead of docstring coloring</li>
    </ul>
    ]]></description>

    <change-notes><![CDATA[
    <b>0.3.0</b>
    <ul>
        <li>Fix <code>sizeof()</code> rejecting general expressions (e.g., <code>sizeof(self.ptr[0].field)</code>)</li>
        <li>Fix false "duplicate parameter name" and "non-default parameter follows default parameter" errors on type bracket arguments like <code>map[void_ptr, void*]</code></li>
    </ul>
    <b>0.2.0</b>
    <ul>
        <li>Resolve <code>ctypedef</code>, <code>ctypedef fused</code>, <code>cdef struct</code> names from included <code>.pxi</code> files (previously showed as unresolved references)</li>
        <li>Fix startup crash (<code>AssertionError</code> in <code>StubElementTypeHolderEP</code>)</li>
    </ul>
    <b>0.1.0</b>
    <ul>
        <li>Fix false "duplicate parameter name" on <code>ndim=1</code> in NumPy buffer syntax</li>
        <li>Fix false "duplicate parameter name" on unnamed parameters in <code>cdef extern</code> declarations</li>
        <li>Fix pointer declarations getting unwanted spaces (<code>float **x</code> → <code>float ** x</code>)</li>
        <li>Fix "unexpected parameter" on <code>__cinit__</code> constructors</li>
        <li>Fix docstrings in <code>cdef</code>/<code>cpdef</code> functions not getting docstring coloring</li>
    </ul>
    ]]></change-notes>

    <depends>com.intellij.modules.platform</depends>
    <depends>com.intellij.modules.python</depends>
    <depends>Pythonid</depends>

    <extensions defaultExtensionNs="com.intellij">
        <!-- Override the Cython parser definition -->
        <lang.parserDefinition
            language="Cython"
            implementationClass="com.cythonfix.parser.FixedCythonParserDefinition"
            order="first"/>

        <!-- Override the Cython formatter -->
        <lang.formatter
            language="Cython"
            implementationClass="com.cythonfix.formatter.FixedCythonFormattingModelBuilder"
            order="first"/>

        <!-- Register stub element type for unnamed Cython parameters -->
        <stubElementTypeHolder class="com.cythonfix.psi.FixedCythonElementTypes"
            externalIdPrefix="py.CYTHON_"/>

        <!-- Apply docstring highlighting in cdef/cpdef function bodies -->
        <annotator language="Python"
            implementationClass="com.cythonfix.annotator.CythonDocstringAnnotator"/>
    </extensions>

    <extensions defaultExtensionNs="Pythonid">
        <!-- Register UNNAMED_PARAMETER as a recognized parameter token -->
        <dialectsTokenSetContributor
            implementation="com.cythonfix.psi.FixedCythonTokenSetContributor"/>

        <!-- Resolve __cinit__ parameters for cdef class constructor calls -->
        <typeProvider implementation="com.cythonfix.type.CythonCinitTypeProvider" order="first"/>

        <!-- Resolve ctypedef/cdef names from included .pxi files -->
        <pyReferenceResolveProvider
            implementation="com.cythonfix.resolve.CythonIncludeResolveProvider"/>
    </extensions>
</idea-plugin>
